# CREDENTIAL ISSUANCE FLOW DIAGRAM

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    KERI/ACDC CREDENTIAL ISSUANCE FLOW                    â”‚
â”‚                  (Issuer â†’ Holder via IPEX Protocol)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ STEP 1: CREATE CREDENTIAL REGISTRY (Issuer)                            â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
  
  Issuer Client
       â”‚
       â”œâ”€â–º registries().create(...)
       â”‚
       â””â”€â–º Returns: Registry SAID (identifier)
           Used to anchor all credentials from this registry

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ STEP 2: ISSUE CREDENTIAL (Issuer)                                      â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›

  Issuer Client
       â”‚
       â”œâ”€â–º credentials().issue(alias, {
       â”‚       ri: registry.regk,      // Registry identifier
       â”‚       s: schemaSaid,           // Schema identifier
       â”‚       a: {                     // Attributes
       â”‚           i: holderAid.i,     // Holder's AID
       â”‚           ...claims           // Credential data
       â”‚       }
       â”‚   })
       â”‚
       â”œâ”€â–º Wait for operation to complete
       â”‚
       â””â”€â–º Returns: Credential SAID
           âš ï¸  BUT: Operation response is INCOMPLETE!

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ STEP 3: ğŸ”‘ RETRIEVE FULL CREDENTIAL (Issuer) - CRITICAL!               â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›

  âŒ WRONG:
     const cred = issueResponse.response;  // Missing IPEX fields!

  âœ… CORRECT:
     await sleep(1000);  // Let KERIA store it
     const cred = await client.credentials().get(credentialSaid);

  Issuer Client
       â”‚
       â”œâ”€â–º credentials().get(credentialSaid)
       â”‚
       â””â”€â–º Returns COMPLETE credential with ALL fields:
           {
             sad: { ... },      // âœ… The ACDC itself
             iss: { ... },      // âœ… Issuance event (TEL)
             anc: { ... },      // âœ… Anchor event (KEL)
             ancatc: "..."      // âœ… Anchor signatures
           }

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ STEP 4: GRANT VIA IPEX (Issuer â†’ Holder)                               â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›

  Issuer Client
       â”‚
       â”œâ”€â–º ipex().grant({
       â”‚       senderName: issuerAlias,
       â”‚       acdc: new Serder(cred.sad),      // âœ… From retrieved cred
       â”‚       iss: new Serder(cred.iss),       // âœ… From retrieved cred
       â”‚       anc: new Serder(cred.anc),       // âœ… From retrieved cred
       â”‚       ancAttachment: cred.ancatc,      // âœ… From retrieved cred
       â”‚       recipient: holderAid.i,
       â”‚       datetime: timestamp
       â”‚   })
       â”‚
       â”œâ”€â–º ipex().submitGrant(...)
       â”‚
       â””â”€â–º Sends IPEX 'exn' message to Holder
           Creates notification for Holder

          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚    NETWORK TRANSMISSION          â”‚
          â”‚    (IPEX Grant Message)          â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ STEP 5: RECEIVE NOTIFICATION (Holder)                                  â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›

  Holder Client
       â”‚
       â”œâ”€â–º notifications().list()
       â”‚   Filter: route = '/exn/ipex/grant', read = false
       â”‚
       â”œâ”€â–º Find grant notification
       â”‚
       â””â”€â–º exchanges().get(notification.a.d)
           Retrieves full grant message with credential

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ STEP 6: ADMIT CREDENTIAL (Holder â†’ Issuer)                             â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›

  Holder Client
       â”‚
       â”œâ”€â–º ipex().admit({
       â”‚       senderName: holderAlias,
       â”‚       grantSaid: notification.a.d,
       â”‚       recipient: issuerAid.i,
       â”‚       datetime: timestamp
       â”‚   })
       â”‚
       â”œâ”€â–º ipex().submitAdmit(...)
       â”‚
       â”œâ”€â–º notifications().mark(notification.i)  // Mark as read
       â”‚
       â””â”€â–º credentials().get(credentialSaid)     // Credential now in store!

          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚    NETWORK TRANSMISSION          â”‚
          â”‚    (IPEX Admit Message)          â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ STEP 7: RECEIVE ADMIT NOTIFICATION (Issuer)                            â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›

  Issuer Client
       â”‚
       â”œâ”€â–º notifications().list()
       â”‚   Filter: route = '/exn/ipex/admit', read = false
       â”‚
       â”œâ”€â–º Find admit notification
       â”‚
       â””â”€â–º notifications().mark(notification.i)  // Mark as read

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                         ISSUANCE COMPLETE!                             â•‘
â•‘  â€¢ Credential issued and recorded in TEL                               â•‘
â•‘  â€¢ Credential anchored to KEL                                          â•‘
â•‘  â€¢ Credential transferred to Holder via IPEX                           â•‘
â•‘  â€¢ Holder has admitted and stored credential                           â•‘
â•‘  â€¢ Both parties acknowledged via notifications                         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      KEY ARCHITECTURAL POINTS                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. KEL (Key Event Log)
   - Tracks the AID's key state (rotation events)
   - Provides cryptographic proof of control

2. TEL (Transaction Event Log) 
   - Tracks credential lifecycle (issuance, revocation)
   - Anchored to KEL for security

3. IPEX (Issuance and Presentation Exchange)
   - Protocol for credential exchange
   - Uses 'exn' (exchange) messages
   - Two-way acknowledgment (grant â†’ admit)

4. Serder (Serializer/Deserializer)
   - Converts KERI events to/from CESR format
   - Used for signing and verification

5. Critical Pattern
   - âœ… Always retrieve credential from client store before IPEX
   - âŒ Never use operation response directly for IPEX
   - â±ï¸  Add small delay after issuance for KERIA processing


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DATA STRUCTURE COMPARISON                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âŒ OPERATION RESPONSE (incomplete):
{
  response: {
    ced: { d: "SAID..." },  // Just the SAID
    // Missing: sad, iss, anc, ancatc
  }
}

âœ… CLIENT STORE (complete):
{
  sad: {                    // The ACDC
    v: "ACDC10JSON...",
    d: "SAID...",
    i: "issuer_AID",
    ri: "registry_SAID",
    s: "schema_SAID",
    a: { /* attributes */ }
  },
  iss: {                    // TEL issuance event
    v: "KERI10JSON...",
    t: "iss",
    d: "event_SAID",
    // ... event details
  },
  anc: {                    // KEL anchor event
    v: "KERI10JSON...",
    t: "ixn",  // or "rot"
    d: "event_SAID",
    // ... anchor data
  },
  ancatc: "-AAB..."         // Signatures
}
